---
import { getCollection, type CollectionEntry } from "astro:content";
import Image from "astro/components/Image.astro";
type TileSource = "pages" | "posts";

type TileEntry = CollectionEntry<"pages"> | CollectionEntry<"posts">;

type Props = {
  source: TileSource;
  count: number;
};

const { source, count } = Astro.props;

let all: TileEntry[] = await getCollection(source);

all = all.filter((t: TileEntry) => t.data.show_tile !== false);

if (source === "posts") {
  // Tell TS to treat 'all' as an array of posts specifically here
  (all as CollectionEntry<"posts">[]).sort((a, b) => {
    const ad = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
    const bd = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
    return bd - ad;
  });
} else {
  // In the else block, we treat them as entries that definitely have a title
  all.sort((a: TileEntry, b: TileEntry) =>
    a.data.title.localeCompare(b.data.title),
  );
}

const tiles = all.slice(0, count);

const base = import.meta.env.BASE_URL;
const joinBase = (p: string) =>
  p.startsWith("http") ? p : `${base.replace(/\/$/, "")}/${p.replace(/^\//, "")}`;

---

<section id="one" class="tiles">
  {
    tiles.map((tile) => (
      <article>
        <span class="image">
          <Image 
        src={tile.data.image} 
        alt={tile.data.title} 
        width={800} 
        height={600} 
      />
        </span>

        <header class="major">
          <h3>
            <a href={joinBase(`/${source}/${tile.slug}`)} class="link">
              {tile.data.title}
            </a>
          </h3>
          <p>{tile.data.description}</p>
        </header>
      </article>
    ))
  }
</section>
